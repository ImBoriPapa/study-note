# MySQL 스레딩 구조
#### MySQL 스레딩 모델
![threading](https://user-images.githubusercontent.com/98242564/207033529-65f0d9e6-6f12-468e-a0a4-1de29050d885.png)

- MySQL 서버는 프로세스기반이 아닌 스레드 기반으로 작동
- 포그라운드(Foreground) 스레드,백그라운드(Background) 스레드로 구분할 수 있다.

### MySQL 서버에서 실행 중인 스레드의 목록을 performance_schema 데이터베이스의 threads 테이블에서 확인할 수 있다.
```
SELECT thread_id, name, type, processlist_user,processlist_user 
FROM performance_schema.threads ORDER BY type, thread_id;
```

## 포그라운드 스레드(클라이언트 스레드)
- 포그라운드 스레드는 최소한 MySQL의 접속된 클라이언트의 수만큼 존재
- 주로 사용자가 요청하는 쿼리 문장을 수행
- 클라이언트 사용자가 작업을 마치고 커넥션을 종료하면 해당 커넥션을 담당하던 스레드는 스레드 캐시로 되돌아간다.
- 이미 스레드 캐시에 일정 개수 이상의 대기중인 스레드가 있으면 스레드 캐시에 넣지 않고 스레드를 종료시켜 일정 개수의 스레드만 캐시에 존재하게 한다.
- 스레드 캐시에 최대 스레드 개수는 'thread_cache_size' 시스템 변수로 설정
- 데이터를 MySQL의 데이터 버퍼나 캐시로부터 가져오며, 버퍼나 캐시에 없는 경우 직접 디스크의 데이터나 인덱스 파일로부터 데이터를 읽어와서 처리
- MyISAM 테이블은 디스크 쓰기 작업까지 포그라운드 스레드가 처리하지만 InnoDB 테이블은 데이터 버퍼나 캐시까지만 스레드가 처리하고 나머지 버퍼로 부터 디스크까지 기록하는 작업은 백그라운드 스레드가 처리

>MySQL에서 사용자 스레드와 포그라운드 스레드는 똑같은 의미로 사용된다.

## 백그라운드 스레드
### InnoDB는 다음과 작업같은 여러 가지 작업이 백그라운드로 처리된다.
- 인서트 버퍼(Insert Buffer)를 병합하는 스레드
- 로그를 디스크로 기록하는 스레드
- InnoDB 버퍼 풀의 데이터를 디스크에 기록하는 스레드
- 데이터를 버퍼로 읽어 오는 스레드
- 잠금이나 데드락을 모니터링 하는 스레드

- 가장 중요한 역할 로그 스레드(Log thread),쓰기 스레드(write thread)
- MySQL 5.5 버전부터 데이터 쓰기 스레드와 데이터 읽기 스레드의 개수를 2개 이상 지정할 수 있게 됬다.
>innodb_write_io_threads, innodb_read_io_threads 시스템 변수로 스레드의 개수 설정

- InnoDB에서도 데이터를 읽는 작업은 주로 클라이언트 스레드에서 처리되기 때문에 읽기 스레드는 많이 설정할 필요가 없다.
- 쓰기 스레드는 아주 많은 작업을 백그라운드로 처리하기 때문에 일반적인 내장 디스크에서는 2~4개, DNS나 SAN 같은 스토리지를 사용시 디스크를 최적으로 사용할 수 있을 만큼 충분힐 설정하는 것이 좋다.
- 사용자의 요청을 처리하는 도중 데이터의 쓰기 작업은 지연되어 처리될 수 있다.
- 데이터의 읽기 작업은 절대 지연될 수 없다.
- 일반적인 상용 DBMS에는 대부분 쓰기 작업을 버퍼링해서 일괄 처리하는 기능이 탑재, InnoDB 또한 이러한 방식으로 처리
- 하지만 MyISAM은 사용자 스레드가 쓰기 작업까지 함께 처리하도록 설계

>InnoDB에서는 INSERT,UPDATE,DELETE 쿼리로 데이터가 변경되는 경우 데이터가 디스크의 데이터 파일로 완전히 저장될 때까지 기다리지 않아도 되지만. MyISAM에서 일반적인 쿼리는 쓰기 버퍼링 기능을 사용할 수 없다.

